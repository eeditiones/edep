<?xml version="1.0" encoding="UTF-8"?>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes" name="viewport"/>

  <title>zotero</title>

  <link href="../../resources/fore.css" rel="stylesheet" media="screen" />
  <!--    <link href="clock.css" rel="stylesheet">-->

  <style>
      .zotero-picker{
          position: relative;
      }
      .zotero-picker fx-repeat{
          display: none;
      }
      .zotero-picker.open fx-repeat{
          display: block;
          position: absolute;
          max-height: 80vh;
          overflow: auto;
      }
      .zotero-picker .bib{
          display: block;
      }
      .zotero-picker .bib:hover{
          background: #efefef;
      }
  </style>
</head>
<body>
<div class="wrapper">
  <fx-fore>
    <fx-action event="ready">
      <fx-setvalue ref="instance('z-vars')/search" value="instance('zotero-ref')/ptr/@target"></fx-setvalue>
      <fx-send submission="s-load"></fx-send>
    </fx-action>
    <fx-model>
      <fx-instance id="zotero-ref"
                   src="templates/fore/data/zotero.xml"
                   xpath-default-namespace="http://www.tei-c.org/ns/1.0">
        <data></data>
      </fx-instance>

      <fx-instance id="zotero-list" type="json">[{}]</fx-instance>

      <fx-instance id="z-vars">
        <data>
          <search></search>
          <open></open>
          <return></return>
        </data>
      </fx-instance>

      <fx-submission id="s-load"
                     url="https://api.zotero.org/groups/2519759/items?q=lat&amp;include=data,bib"
                     method="get"
                     replace="instance"
                     instance="zotero-list"
                     validate="false"></fx-submission>

    </fx-model>

    <section id="zotero-picker" class="zotero-picker {instance('z-vars')/open}">
<!--
      <fx-action event="ref-selected">
        <fx-message>return {instance('z-vars')/return}</fx-message>
        <fx-load url="https://api.zotero.org/groups/2519759/items?tag={instance('z-vars')/return}&amp;format=bib&amp;style=digital-humanities-im-deutschsprachigen-raum"
                 attach-to="#zotero-bib-output"></fx-load>
      </fx-action>
-->

      <header>
        <fx-control ref="instance('z-vars')/search" update-event="input">
          <label><pb-i18n key="form.reference">Referenz</pb-i18n></label>
          <fx-action event="value-changed">
            <fx-update></fx-update>
            <fx-refresh></fx-refresh>
            <fx-setvalue ref="instance('z-vars')/open" if="string-length(context())=1">open</fx-setvalue>
          </fx-action>
        </fx-control>
        <div id="zotero-bib-output"></div>
      </header>
      <fx-repeat id="r-bibs" ref="instance('zotero-list')?*">
        <template>
          <fx-var name="current" value="."></fx-var>
          <fx-output class="bib" tabindex="0" ref="?bib[contains(.,instance('z-vars')/search)]" mediatype="html">
            <fx-action event="click">
              <fx-setvalue ref="instance('z-vars')/open"></fx-setvalue>
              <fx-setvalue ref="instance('z-vars')/search" value="$current?data?tags(1)?tag"></fx-setvalue>
              <fx-setvalue ref="instance('z-vars')/return" value="$current?data?tags(1)?tag"></fx-setvalue>
              <fx-return ref="instance('z-vars')/return/text()"></fx-return>
<!--              <fx-dispatch name="ref-selected" targetid="zotero-picker"></fx-dispatch>-->
            </fx-action>
            <fx-action event="keydown" if="event('code') = 'Enter'">
              <fx-setvalue ref="instance('z-vars')/open"></fx-setvalue>
              <fx-setvalue ref="instance('z-vars')/return" value="$current?data?tags(1)?tag"></fx-setvalue>
            </fx-action>
          </fx-output>

        </template>
      </fx-repeat>
    </section>
  </fx-fore>

</div>
<script type="module" src="../demo.js"></script>
</body>

</html>
